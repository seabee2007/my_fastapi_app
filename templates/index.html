<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CQI Assessment Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font for a modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007bff;
      --primary-color-hover: #0056b3;
      --bg-color: #f4f4f4;
      --container-bg: #ffffff;
      --border-color: #ccc;
      --border-radius: 5px;
      --input-padding: 10px;
      --max-container-width: 900px;
      --font-color: #333;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
      color: var(--font-color);
    }
    .container {
      max-width: var(--max-container-width);
      margin: 0 auto;
      background: var(--container-bg);
      padding: 30px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      border-radius: var(--border-radius);
    }
    h1, h2, h3 {
      text-align: center;
      margin-bottom: 15px;
    }
    .error-messages {
      background: #fdd;
      border: 1px solid #f99;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: var(--border-radius);
    }
    .item-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: var(--border-radius);
    }
    .number-input {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .number-input button {
      background-color: var(--primary-color);
      border: none;
      color: #fff;
      width: 30px;
      height: 30px;
      font-size: 1.2em;
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: background 0.3s;
    }
    .number-input button:hover {
      background-color: var(--primary-color-hover);
    }
    .number-input input {
      text-align: center;
      width: 80px;
      margin: 0 5px;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
    }
    label {
      font-weight: 500;
      display: block;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: var(--input-padding);
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1em;
      box-sizing: border-box;
    }
    input[type="radio"] {
      margin-right: 5px;
    }
    button {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease;
      display: block;
      margin: 20px auto;
    }
    button:hover {
      background-color: var(--primary-color-hover);
    }
    #final_score_display {
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 20px;
    }
    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }
      input, select, textarea, button {
        font-size: 0.9em;
      }
    }
    /* ---------- PDF Modal Styles ---------- */
    .pdf-ref-icon {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--primary-color, #007bff);
      color: #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      text-align: center;
      line-height: 50px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: background 0.3s;
    }
    .pdf-ref-icon:hover {
      background: #0056b3;
    }
    .pdf-ref-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .pdf-ref-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 800px;
      border-radius: 5px;
      text-align: center;
    }
    .pdf-ref-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .pdf-ref-close:hover,
    .pdf-ref-close:focus {
      color: black;
      text-decoration: none;
    }

    /* ---------- Manday Modal Styles ---------- */
    .manday-icon {
      position: fixed;
      bottom: 90px; /* Adjust to appear above the PDF icon */
      right: 20px;
      background: var(--primary-color, #007bff);
      color: #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      text-align: center;
      line-height: 50px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: background 0.3s;
    }
    .manday-icon:hover {
      background: #0056b3;
    }
    .manday-modal {
      display: none;
      position: fixed;
      z-index: 1002;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .manday-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 400px;
      border-radius: 5px;
      text-align: center;
    }
    .manday-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .manday-close:hover,
    .manday-close:focus {
      color: black;
      text-decoration: none;
    }
    .manday-content input[type="number"] {
      width: 90%;
      padding: 5px;
      margin: 5px 0 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1em;
    }

    /* ---------- Calculator Modal Styles ---------- */
    .calc-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary-color, #007bff);
      color: #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      text-align: center;
      line-height: 50px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      transition: background 0.3s;
    }
    .calc-icon:hover {
      background: #0056b3;
    }
    .calc-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .calc-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 400px;
      border-radius: 5px;
      text-align: center;
    }
    .calc-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .calc-close:hover,
    .calc-close:focus {
      color: black;
      text-decoration: none;
    }
    .calc-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .calc-btn {
      padding: 15px;
      font-size: 1.2em;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #808080;
      border-radius: 5px;
      transition: background 0.3s;
    }
    .calc-btn:hover {
      background: #a0a0a0;
    }
    @media (max-width: 600px) {
      .calc-content {
        width: 80%;
        margin: 20% auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CQI Assessment Tool</h1>

    <!-- Display errors if any -->
    {% if errors %}
      <div class="error-messages">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" action="/submit_assessment" id="assessmentForm">
      <!-- Project Information -->
      <h2>Project Information</h2>
      <div class="item-section">
        <label>Project Name:</label>
        <input type="text" name="project_name" value="{{ form_data.project_name if form_data and form_data.project_name is defined else '' }}">
      </div>
      <div class="item-section">
        <label>Battalion:</label>
        <select name="battalion">
          <option value="NMCB ONE" {% if form_data and form_data.battalion=='NMCB ONE' %}selected{% endif %}>NMCB ONE</option>
          <option value="NMCB THREE" {% if form_data and form_data.battalion=='NMCB THREE' %}selected{% endif %}>NMCB THREE</option>
          <option value="NMCB FOUR" {% if form_data and form_data.battalion=='NMCB FOUR' %}selected{% endif %}>NMCB FOUR</option>
          <option value="NMCB FIVE" {% if form_data and form_data.battalion=='NMCB FIVE' %}selected{% endif %}>NMCB FIVE</option>
          <option value="NMCB ELEVEN" {% if form_data and form_data.battalion=='NMCB ELEVEN' %}selected{% endif %}>NMCB ELEVEN</option>
          <option value="NMCB ONE THIRTY THREE" {% if form_data and form_data.battalion=='NMCB ONE THIRTY THREE' %}selected{% endif %}>NMCB ONE THIRTY THREE</option>
        </select>
      </div>
      <div class="item-section">
        <label>OIC:</label>
        <input type="text" name="oic_name" value="{{ form_data.oic_name if form_data and form_data.oic_name is defined else '' }}">
      </div>
      <div class="item-section">
        <label>AOIC:</label>
        <input type="text" name="aoic_name" value="{{ form_data.aoic_name if form_data and form_data.aoic_name is defined else '' }}">
      </div>
      <div class="item-section">
        <label>Start Date:</label>
        <input type="date" name="start_date" value="{{ form_data.start_date if form_data and form_data.start_date is defined else '' }}">
      </div>
      <div class="item-section">
        <label>Planned Start Date:</label>
        <input type="date" name="planned_start" value="{{ form_data.planned_start if form_data and form_data.planned_start is defined else '' }}">
      </div>
      <div class="item-section">
        <label>Planned Completion Date:</label>
        <input type="date" name="planned_completion" value="{{ form_data.planned_completion if form_data and form_data.planned_completion is defined else '' }}">
      </div>
      
      <!-- Items 1-29 -->
      <!-- Item 1 -->
      <div class="item-section">
        <h3>Item 1 â€“ Self Assessment</h3>
        <p>(Yes = 2 pts, No = 0 pts, N/A = deduct 2 pts)</p>
        <label><input type="radio" name="item1" value="2" {% if form_data and form_data.item1=='2' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item1" value="0" {% if form_data and form_data.item1=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item1" value="-2" {% if form_data and form_data.item1=='-2' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item1">{{ form_data.comment_item1 if form_data and form_data.comment_item1 is defined else '' }}</textarea>
      </div>
      <!-- Item 2 -->
      <div class="item-section">
        <h3>Item 2 â€“ Self Assessment Submission</h3>
        <p>(Yes = 2 pts, No = 0 pts, N/A = deduct 2 pts)</p>
        <label><input type="radio" name="item2" value="2" {% if form_data and form_data.item2=='2' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item2" value="0" {% if form_data and form_data.item2=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item2" value="-2" {% if form_data and form_data.item2=='-2' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item2">{{ form_data.comment_item2 if form_data and form_data.comment_item2 is defined else '' }}</textarea>
      </div>
      <!-- Item 3 -->
      <div class="item-section">
        <h3>Item 3 â€“ Notice to Proceed (NTP)</h3>
        <p>(Yes = 4 pts, No = 0 pts, N/A = deduct 4 pts)</p>
        <label><input type="radio" name="item3" value="4" {% if form_data and form_data.item3=='4' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item3" value="0" {% if form_data and form_data.item3=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item3" value="-4" {% if form_data and form_data.item3=='-4' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item3">{{ form_data.comment_item3 if form_data and form_data.comment_item3 is defined else '' }}</textarea>
      </div>
      <!-- Item 4 â€“ Dynamic Calculation -->
      <div class="item-section" id="item4_section">
        <h3>Item 4 â€“ Project Schedule (Dynamic Calculation)</h3>
        <p>(Exact = 16 pts; Within deviation = 12 pts; Outside deviation = 4 pts; Not monitored = 0 pts; N/A = deduct 16 pts)</p>
        <p>
          <label><input type="radio" name="item4_option" value="calc" id="item4_calc_option" {% if not form_data or form_data.item4_option is not defined or form_data.item4_option == "calc" %}checked{% endif %}> Use Calculation</label>
          <label><input type="radio" name="item4_option" value="-16" id="item4_na_option" {% if form_data and form_data.item4_option == "-16" %}checked{% endif %}> N/A</label>
        </p>
        <div id="item4_calc_div">
          <label>Total Project Mandays:</label>
          <div class="number-input">
            <button type="button" onclick="decrement('total_md')">â€“</button>
            <input type="number" id="total_md" name="total_md" value="{{ form_data.total_md if form_data and form_data.total_md is defined else '1000' }}" step="1" oninput="calculateItem4Score()">
            <button type="button" onclick="increment('total_md')">+</button>
          </div>
          <label>Planned Work-in-Place (%):</label>
          <div class="number-input">
            <button type="button" onclick="decrement('planned_wip')">â€“</button>
            <input type="number" id="planned_wip" name="planned_wip" value="{{ form_data.planned_wip if form_data and form_data.planned_wip is defined else '100' }}" step="1" oninput="calculateItem4Score()">
            <button type="button" onclick="increment('planned_wip')">+</button>
          </div>
          <label>Actual Work-in-Place (%):</label>
          <div class="number-input">
            <button type="button" onclick="decrement('actual_wip')">â€“</button>
            <input type="number" id="actual_wip" name="actual_wip" value="{{ form_data.actual_wip if form_data and form_data.actual_wip is defined else '100' }}" step="1" oninput="calculateItem4Score()">
            <button type="button" onclick="increment('actual_wip')">+</button>
          </div>
          <p id="item4_score_display">Calculated Score for Item 4: <span id="calcScoreDisplay">16</span></p>
          <input type="hidden" id="item4_score" name="item4_score" value="{{ form_data.item4_score if form_data and form_data.item4_score is defined else '16' }}">
        </div>
        <label>Comment (required if N/A or score not perfect):</label>
        <textarea id="comment_item4" name="comment_item4">{{ form_data.comment_item4 if form_data and form_data.comment_item4 is defined else '' }}</textarea>
      </div>
      <!-- Item 5 -->
      <div class="item-section">
        <h3>Item 5 â€“ Project Management</h3>
        <p>(Yes = 2 pts, No = 0 pts, N/A = deduct 2 pts)</p>
        <label><input type="radio" name="item5" value="2" {% if form_data and form_data.item5=='2' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item5" value="0" {% if form_data and form_data.item5=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item5" value="-2" {% if form_data and form_data.item5=='-2' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item5">{{ form_data.comment_item5 if form_data and form_data.comment_item5 is defined else '' }}</textarea>
      </div>
      <!-- Item 6 â€“ QA for 30 NCR Detail Sites -->
      <div class="item-section">
        <h3>Item 6 â€“ QA for 30 NCR Detail Sites</h3>
        <p>(4 pts = Zero discrepancies; 3 pts = Acceptable; 2 pts = Multiple discrepancies; 0 pts = No QA involvement; N/A = deduct 4 pts)</p>
        <select name="item6">
          <option value="4" {% if form_data and form_data.item6=='4' %}selected{% endif %}>4</option>
          <option value="3" {% if form_data and form_data.item6=='3' %}selected{% endif %}>3</option>
          <option value="2" {% if form_data and form_data.item6=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item6=='0' %}selected{% endif %}>0</option>
          <option value="-4" {% if form_data and form_data.item6=='-4' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item6">{{ form_data.comment_item6 if form_data and form_data.comment_item6 is defined else '' }}</textarea>
      </div>
      <!-- Item 7 & 8 â€“ FAR/RFI -->
      <div class="item-section">
        <h3>Item 7 &amp; 8 â€“ FAR/RFI</h3>
        <p>(4 pts = 100% logged; 3 pts = Acceptable; 2 pts = Missing; 0 pts = Not tracked; N/A = deduct 4 pts)</p>
        <select name="item78">
          <option value="4" {% if form_data and form_data.item78=='4' %}selected{% endif %}>4</option>
          <option value="3" {% if form_data and form_data.item78=='3' %}selected{% endif %}>3</option>
          <option value="2" {% if form_data and form_data.item78=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item78=='0' %}selected{% endif %}>0</option>
          <option value="-4" {% if form_data and form_data.item78=='-4' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item78">{{ form_data.comment_item78 if form_data and form_data.comment_item78 is defined else '' }}</textarea>
      </div>
      <!-- Item 9 â€“ DFOW Sheet -->
      <div class="item-section">
        <h3>Item 9 â€“ DFOW Sheet</h3>
        <p>(4 pts = Accurate; 3 pts = Acceptable; 2 pts = Incorrect; 0 pts = Blank; N/A = deduct 4 pts)</p>
        <select name="item9">
          <option value="4" {% if form_data and form_data.item9=='4' %}selected{% endif %}>4</option>
          <option value="3" {% if form_data and form_data.item9=='3' %}selected{% endif %}>3</option>
          <option value="2" {% if form_data and form_data.item9=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item9=='0' %}selected{% endif %}>0</option>
          <option value="-4" {% if form_data and form_data.item9=='-4' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item9">{{ form_data.comment_item9 if form_data and form_data.comment_item9 is defined else '' }}</textarea>
      </div>
      <!-- Item 10 â€“ Turnover Projects -->
      <div class="item-section">
        <h3>Item 10 â€“ Turnover Projects</h3>
        <p>(4 pts = Validated discrepancies with rework plan; 0 pts = No documentation; N/A = deduct 4 pts)</p>
        <select name="item10">
          <option value="4" {% if form_data and form_data.item10=='4' %}selected{% endif %}>4</option>
          <option value="0" {% if form_data and form_data.item10=='0' %}selected{% endif %}>0</option>
          <option value="-4" {% if form_data and form_data.item10=='-4' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item10">{{ form_data.comment_item10 if form_data and form_data.comment_item10 is defined else '' }}</textarea>
      </div>
      <!-- Item 11 â€“ Funds Provided -->
      <div class="item-section">
        <h3>Item 11 â€“ Funds Provided</h3>
        <p>(Yes = 4 pts, No = 0 pts, N/A = deduct 4 pts)</p>
        <label><input type="radio" name="item11" value="4" {% if form_data and form_data.item11=='4' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item11" value="0" {% if form_data and form_data.item11=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item11" value="-4" {% if form_data and form_data.item11=='-4' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item11">{{ form_data.comment_item11 if form_data and form_data.comment_item11 is defined else '' }}</textarea>
      </div>
      <!-- Item 12 â€“ Estimate at Completion Cost (EAC) -->
      <div class="item-section">
        <h3>Item 12 â€“ Estimate at Completion Cost (EAC)</h3>
        <p>(4 pts = Accurate; 3 pts = Acceptable; 2 pts = Low accuracy; 0 pts = â‰¤59% accuracy; N/A = deduct 4 pts)</p>
        <select name="item12">
          <option value="4" {% if form_data and form_data.item12=='4' %}selected{% endif %}>4</option>
          <option value="3" {% if form_data and form_data.item12=='3' %}selected{% endif %}>3</option>
          <option value="2" {% if form_data and form_data.item12=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item12=='0' %}selected{% endif %}>0</option>
          <option value="-4" {% if form_data and form_data.item12=='-4' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item12">{{ form_data.comment_item12 if form_data and form_data.comment_item12 is defined else '' }}</textarea>
      </div>
      <!-- Item 13 â€“ Current Expenditures -->
      <div class="item-section">
        <h3>Item 13 â€“ Current Expenditures</h3>
        <p>(4 pts = Accurate; 3 pts = Acceptable; 2 pts = Discrepancies; 0 pts = â‰¤59% accuracy; N/A = deduct 4 pts)</p>
        <select name="item13">
          <option value="4" {% if form_data and form_data.item13=='4' %}selected{% endif %}>4</option>
          <option value="3" {% if form_data and form_data.item13=='3' %}selected{% endif %}>3</option>
          <option value="2" {% if form_data and form_data.item13=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item13=='0' %}selected{% endif %}>0</option>
          <option value="-4" {% if form_data and form_data.item13=='-4' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item13">{{ form_data.comment_item13 if form_data and form_data.comment_item13 is defined else '' }}</textarea>
      </div>
      <!-- Item 14 â€“ Project Material Status Report (PMSR) -->
      <div class="item-section">
        <h3>Item 14 â€“ Project Material Status Report (PMSR)</h3>
        <p>(10 pts = 100% valid; 8 pts = Acceptable; 4 pts = Discrepancies; 2/0 pts otherwise; N/A = deduct 10 pts)</p>
        <select name="item14">
          <option value="10" {% if form_data and form_data.item14=='10' %}selected{% endif %}>10</option>
          <option value="8" {% if form_data and form_data.item14=='8' %}selected{% endif %}>8</option>
          <option value="4" {% if form_data and form_data.item14=='4' %}selected{% endif %}>4</option>
          <option value="2" {% if form_data and form_data.item14=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item14=='0' %}selected{% endif %}>0</option>
          <option value="-10" {% if form_data and form_data.item14=='-10' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item14">{{ form_data.comment_item14 if form_data and form_data.comment_item14 is defined else '' }}</textarea>
      </div>
      <!-- Item 15 â€“ Report Submission -->
      <div class="item-section">
        <h3>Item 15 â€“ Report Submission</h3>
        <p>(Yes = 2 pts, No = 0 pts, N/A = deduct 2 pts)</p>
        <label><input type="radio" name="item15" value="2" {% if form_data and form_data.item15=='2' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item15" value="0" {% if form_data and form_data.item15=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item15" value="-2" {% if form_data and form_data.item15=='-2' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item15">{{ form_data.comment_item15 if form_data and form_data.comment_item15 is defined else '' }}</textarea>
      </div>
      <!-- Item 16 â€“ Materials On-Hand -->
      <div class="item-section">
        <h3>Item 16 â€“ Materials On-Hand</h3>
        <p>(10 pts = Organized; 8 pts = Minor issues; 4 pts = Multiple issues; 0 pts = Unsatisfactory; N/A = deduct 10 pts)</p>
        <select name="item16">
          <option value="10" {% if form_data and form_data.item16=='10' %}selected{% endif %}>10</option>
          <option value="8" {% if form_data and form_data.item16=='8' %}selected{% endif %}>8</option>
          <option value="4" {% if form_data and form_data.item16=='4' %}selected{% endif %}>4</option>
          <option value="0" {% if form_data and form_data.item16=='0' %}selected{% endif %}>0</option>
          <option value="-10" {% if form_data and form_data.item16=='-10' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item16">{{ form_data.comment_item16 if form_data and form_data.comment_item16 is defined else '' }}</textarea>
      </div>
      <!-- Item 17 â€“ DD Form 200 -->
      <div class="item-section">
        <h3>Item 17 â€“ DD Form 200</h3>
        <p>(Yes = 2 pts, No = 0 pts, N/A = deduct 2 pts)</p>
        <label><input type="radio" name="item17" value="2" {% if form_data and form_data.item17=='2' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item17" value="0" {% if form_data and form_data.item17=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item17" value="-2" {% if form_data and form_data.item17=='-2' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item17">{{ form_data.comment_item17 if form_data and form_data.comment_item17 is defined else '' }}</textarea>
      </div>
      <!-- Item 18 â€“ Borrowed Material Tickler File -->
      <div class="item-section">
        <h3>Item 18 â€“ Borrowed Material Tickler File</h3>
        <p>(Yes = 2 pts, No = 0 pts, N/A = deduct 2 pts)</p>
        <label><input type="radio" name="item18" value="2" {% if form_data and form_data.item18=='2' %}checked{% endif %}> Yes</label>
        <label><input type="radio" name="item18" value="0" {% if form_data and form_data.item18=='0' %}checked{% endif %}> No</label>
        <label><input type="radio" name="item18" value="-2" {% if form_data and form_data.item18=='-2' %}checked{% endif %}> N/A</label>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item18">{{ form_data.comment_item18 if form_data and form_data.item18 is defined else '' }}</textarea>
      </div>
      <!-- Item 19 â€“ Project Brief -->
      <div class="item-section">
        <h3>Item 19 â€“ Project Brief</h3>
        <p>(5 pts = Detailed; 3 pts = Acceptable; 2 pts or 0 pts otherwise; N/A = deduct 5 pts)</p>
        <select name="item19">
          <option value="5" {% if form_data and form_data.item19=='5' %}selected{% endif %}>5</option>
          <option value="3" {% if form_data and form_data.item19=='3' %}selected{% endif %}>3</option>
          <option value="2" {% if form_data and form_data.item19=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item19=='0' %}selected{% endif %}>0</option>
          <option value="-5" {% if form_data and form_data.item19=='-5' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item19">{{ form_data.comment_item19 if form_data and form_data.comment_item19 is defined else '' }}</textarea>
      </div>
      <!-- Item 20 â€“ Calculate Manday Capability -->
      <div class="item-section">
        <h3>Item 20 â€“ Calculate Manday Capability</h3>
        <p>(6 pts = Matches; 4/2/0 pts otherwise; N/A = deduct 6 pts)</p>
        <select name="item20">
          <option value="6" {% if form_data and form_data.item20=='6' %}selected{% endif %}>6</option>
          <option value="4" {% if form_data and form_data.item20=='4' %}selected{% endif %}>4</option>
          <option value="2" {% if form_data and form_data.item20=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item20=='0' %}selected{% endif %}>0</option>
          <option value="-6" {% if form_data and form_data.item20=='-6' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item20">{{ form_data.comment_item20 if form_data and form_data.comment_item20 is defined else '' }}</textarea>
      </div>
      <!-- Item 21 â€“ Equipment -->
      <div class="item-section">
        <h3>Item 21 â€“ Equipment</h3>
        <p>(6 pts = All onsite; 4 pts = Acceptable; 2 pts = Partial; 0 pts = None; N/A = deduct 6 pts)</p>
        <select name="item21">
          <option value="6" {% if form_data and form_data.item21=='6' %}selected{% endif %}>6</option>
          <option value="4" {% if form_data and form_data.item21=='4' %}selected{% endif %}>4</option>
          <option value="2" {% if form_data and form_data.item21=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item21=='0' %}selected{% endif %}>0</option>
          <option value="-6" {% if form_data and form_data.item21=='-6' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item21">{{ form_data.comment_item21 if form_data and form_data.item21 is defined else '' }}</textarea>
      </div>
      <!-- Item 22 â€“ CASS Spot Check -->
      <div class="item-section">
        <h3>Item 22 â€“ CASS Spot Check</h3>
        <p>(12 pts = 100% compliant; 8/4/0 pts otherwise; N/A = deduct 12 pts)</p>
        <select name="item22">
          <option value="12" {% if form_data and form_data.item22=='12' %}selected{% endif %}>12</option>
          <option value="8" {% if form_data and form_data.item22=='8' %}selected{% endif %}>8</option>
          <option value="4" {% if form_data and form_data.item22=='4' %}selected{% endif %}>4</option>
          <option value="0" {% if form_data and form_data.item22=='0' %}selected{% endif %}>0</option>
          <option value="-12" {% if form_data and form_data.item22=='-12' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item22">{{ form_data.comment_item22 if form_data and form_data.comment_item22 is defined else '' }}</textarea>
      </div>
      <!-- Item 23 â€“ Designation Letters -->
      <div class="item-section">
        <h3>Item 23 â€“ Designation Letters</h3>
        <p>(5 pts = Current; 3 pts = Not up-to-date; 0 pts = Missing; N/A = deduct 5 pts)</p>
        <select name="item23">
          <option value="5" {% if form_data and form_data.item23=='5' %}selected{% endif %}>5</option>
          <option value="3" {% if form_data and form_data.item23=='3' %}selected{% endif %}>3</option>
          <option value="0" {% if form_data and form_data.item23=='0' %}selected{% endif %}>0</option>
          <option value="-5" {% if form_data and form_data.item23=='-5' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item23">{{ form_data.comment_item23 if form_data and form_data.item23 is defined else '' }}</textarea>
      </div>
      <!-- Item 24 â€“ Job Box Review -->
      <div class="item-section" id="item24_section">
        <h3>Item 24 â€“ Job Box Review</h3>
        <p>(20 pts maximum; deductions apply; N/A = deduct 20 pts)</p>
        <select name="item24" id="item24_select">
          <option value="20" {% if form_data and form_data.item24=='20' %}selected{% endif %}>20</option>
          <option value="0" {% if form_data and form_data.item24=='0' %}selected{% endif %}>0</option>
          <option value="-20" {% if form_data and form_data.item24=='-20' %}selected{% endif %}>N/A</option>
        </select>
        <label>Deduction:</label>
        <input type="number" name="deduction24" id="deduction24" value="{{ form_data.deduction24 if form_data and form_data.deduction24 is defined else '0' }}" min="0" max="20">
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item24">{{ form_data.comment_item24 if form_data and form_data.comment_item24 is defined else '' }}</textarea>
      </div>
      <!-- Item 25 â€“ Review QC Package -->
      <div class="item-section">
        <h3>Item 25 â€“ Review QC Package</h3>
        <p>(8 pts = Comprehensive; 6/4/0 pts otherwise; N/A = deduct 8 pts)</p>
        <select name="item25">
          <option value="8" {% if form_data and form_data.item25=='8' %}selected{% endif %}>8</option>
          <option value="6" {% if form_data and form_data.item25=='6' %}selected{% endif %}>6</option>
          <option value="4" {% if form_data and form_data.item25=='4' %}selected{% endif %}>4</option>
          <option value="0" {% if form_data and form_data.item25=='0' %}selected{% endif %}>0</option>
          <option value="-8" {% if form_data and form_data.item25=='-8' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item25">{{ form_data.comment_item25 if form_data and form_data.comment_item25 is defined else '' }}</textarea>
      </div>
      <!-- Item 26 â€“ Submittals -->
      <div class="item-section">
        <h3>Item 26 â€“ Submittals</h3>
        <p>(4 pts = Current; 2 pts = Not current; 0 pts = Not submitted; N/A = deduct 4 pts)</p>
        <select name="item26">
          <option value="4" {% if form_data and form_data.item26=='4' %}selected{% endif %}>4</option>
          <option value="2" {% if form_data and form_data.item26=='2' %}selected{% endif %}>2</option>
          <option value="0" {% if form_data and form_data.item26=='0' %}selected{% endif %}>0</option>
          <option value="-4" {% if form_data and form_data.item26=='-4' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item26">{{ form_data.comment_item26 if form_data and form_data.item26 is defined else '' }}</textarea>
      </div>
      <!-- Item 27a â€“ QC Inspection Plan -->
      <div class="item-section">
        <h3>Item 27a â€“ QC Inspection Plan</h3>
        <p>(10 pts = 100% quantifiable; 7/3/0 pts otherwise; N/A = deduct 10 pts)</p>
        <select name="item27a">
          <option value="10" {% if form_data and form_data.item27a=='10' %}selected{% endif %}>10</option>
          <option value="8" {% if form_data and form_data.item27a=='8' %}selected{% endif %}>8</option>
          <option value="6" {% if form_data and form_data.item27a=='6' %}selected{% endif %}>6</option>
          <option value="0" {% if form_data and form_data.item27a=='0' %}selected{% endif %}>0</option>
          <option value="-10" {% if form_data and form_data.item27a=='-10' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item27a">{{ form_data.comment_item27a if form_data and form_data.comment_item27a is defined else '' }}</textarea>
      </div>
      <!-- Item 27b â€“ QC Inspection -->
      <div class="item-section">
        <h3>Item 27b â€“ QC Inspection</h3>
        <p>(5 pts = No discrepancies; 0 pts otherwise; N/A = deduct 5 pts)</p>
        <select name="item27b">
          <option value="5" {% if form_data and form_data.item27b=='5' %}selected{% endif %}>5</option>
          <option value="0" {% if form_data and form_data.item27b=='0' %}selected{% endif %}>0</option>
          <option value="-5" {% if form_data and form_data.item27b=='-5' %}selected{% endif %}>N/A</option>
        </select>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item27b">{{ form_data.comment_item27b if form_data and form_data.comment_item27b is defined else '' }}</textarea>
      </div>
      <!-- Item 28 â€“ Job Box Review (QC) -->
      <div class="item-section" id="item28_section">
        <h3>Item 28 â€“ Job Box Review (QC)</h3>
        <p>(Maximum 5 pts; deductions apply; N/A = deduct 5 pts)</p>
        <label><input type="radio" name="item28_option" value="5" {% if not form_data or form_data.item28_option is not defined or form_data.item28_option=='5' %}checked{% endif %}> Applicable</label>
        <label><input type="radio" name="item28_option" value="-5" {% if form_data and form_data.item28_option=='-5' %}checked{% endif %}> N/A</label>
        <div id="item28_input_div">
          <label>Deduction:</label>
          <input type="number" name="deduction28" id="deduction28" value="{{ form_data.deduction28 if form_data and form_data.deduction28 is defined else '0' }}" min="0" max="5">
        </div>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item28">{{ form_data.comment_item28 if form_data and form_data.comment_item28 is defined else '' }}</textarea>
      </div>
      <!-- Item 29 â€“ Job Box Review (Safety) -->
      <div class="item-section" id="item29_section">
        <h3>Item 29 â€“ Job Box Review (Safety)</h3>
        <p>(Maximum 5 pts; deductions apply; N/A = deduct 5 pts)</p>
        <label><input type="radio" name="item29_option" value="5" {% if not form_data or form_data.item29_option is not defined or form_data.item29_option=='5' %}checked{% endif %}> Applicable</label>
        <label><input type="radio" name="item29_option" value="-5" {% if form_data and form_data.item29_option=='-5' %}checked{% endif %}> N/A</label>
        <div id="item29_input_div">
          <label>Deduction:</label>
          <input type="number" name="deduction29" id="deduction29" value="{{ form_data.deduction29 if form_data and form_data.deduction29 is defined else '0' }}" min="0" max="5">
        </div>
        <label>Comment (required if N/A):</label>
        <textarea name="comment_item29">{{ form_data.comment_item29 if form_data and form_data.comment_item29 is defined else '' }}</textarea>
      </div>
      
      <!-- Hidden input for final score -->
      <input type="hidden" name="final_score" id="final_score_input">
      <button type="submit">Submit Assessment</button>
    </form>
    <button type="button" onclick="calculateFinalScore()">Calculate Final Score</button>
    <div id="final_score_display"></div>
  </div>
  <script>
    function decrement(id) {
      var input = document.getElementById(id);
      input.value = parseInt(input.value) - 1;
      input.dispatchEvent(new Event('input'));
    }
    function increment(id) {
      var input = document.getElementById(id);
      input.value = parseInt(input.value) + 1;
      input.dispatchEvent(new Event('input'));
    }
    function calculateItem4Score() {
      var total_md = parseFloat(document.getElementById('total_md').value);
      var planned_wip = parseFloat(document.getElementById('planned_wip').value);
      var actual_wip = parseFloat(document.getElementById('actual_wip').value);
      var calcScore = 16; // Default for exact match
      if(total_md && planned_wip && actual_wip){
         var deviation = Math.abs(planned_wip - actual_wip);
         if(deviation === 0) {
           calcScore = 16;
         } else if(deviation <= 10) {
           calcScore = 12;
         } else {
           calcScore = 4;
         }
      }
      document.getElementById('item4_score_display').innerText = "Calculated Score for Item 4: " + calcScore;
      document.getElementById('item4_score').value = calcScore;
    }
    function calculateFinalScore() {
      var total = 0;
      function getRadioValue(name) {
        var radio = document.querySelector('input[name="'+name+'"]:checked');
        return radio ? parseFloat(radio.value) : 0;
      }
      function getSelectValue(name) {
        var select = document.querySelector('select[name="'+name+'"]');
        return select ? parseFloat(select.value) : 0;
      }
      function getHiddenValue(id) {
        var elem = document.getElementById(id);
        return elem ? parseFloat(elem.value) : 0;
      }
      // Radio button items
      total += getRadioValue("item1");
      total += getRadioValue("item2");
      total += getRadioValue("item3");
      // For Item 4, use the calculated score or N/A option
      var item4Option = document.querySelector('input[name="item4_option"]:checked').value;
      if(item4Option === "calc") {
        total += getHiddenValue("item4_score");
      } else {
        total += parseFloat(item4Option);
      }
      total += getRadioValue("item5");
      // Select items
      total += getSelectValue("item6");
      total += getSelectValue("item78");
      total += getSelectValue("item9");
      total += getSelectValue("item10");
      total += getRadioValue("item11");
      total += getSelectValue("item12");
      total += getSelectValue("item13");
      total += getSelectValue("item14");
      total += getRadioValue("item15");
      total += getSelectValue("item16");
      total += getRadioValue("item17");
      total += getRadioValue("item18");
      total += getSelectValue("item19");
      total += getSelectValue("item20");
      total += getSelectValue("item21");
      total += getSelectValue("item22");
      total += getSelectValue("item23");
      total += getSelectValue("item24");
      // Apply manual deduction for Item 24
      total -= parseFloat(document.getElementById('deduction24').value || 0);
      total += getSelectValue("item25");
      total += getSelectValue("item26");
      total += getSelectValue("item27a");
      total += getSelectValue("item27b");
      // Items 28 and 29 (radio buttons with extra deductions)
      total += getRadioValue("item28_option");
      total -= parseFloat(document.getElementById('deduction28').value || 0);
      total += getRadioValue("item29_option");
      total -= parseFloat(document.getElementById('deduction29').value || 0);
      
      document.getElementById('final_score_input').value = total;
      document.getElementById('final_score_display').innerText = "Final Score: " + total;
    }
  </script>

<div id="pdf-ref-icon" class="pdf-ref-icon">
  <a href="https://www.marines.mil/portals/1/mcrp%203-17.7f%20z.pdf" target="_blank" style="color: inherit; text-decoration: none;">PDF</a>
</div>

  <!-- ---------- Manday Modal ---------- -->
  <!-- Manday Capability Modal Trigger -->
  <div id="manday-icon" class="manday-icon">MC</div>
  <!-- Manday Capability Modal Structure -->
  <div id="manday-modal" class="manday-modal">
    <div class="manday-content">
      <span id="manday-close" class="manday-close">&times;</span>
      <h2>Manday Capability Calculator</h2>
      <p>Calculate MD Capability: MC = DL Ã— WD Ã— ME Ã— AF</p>
      <label for="dl_input">Direct Labor (DL):</label>
      <input type="number" id="dl_input" placeholder="Enter DL" step="1" min="0">
      
      <label for="wd_input">Available Workdays (WD):</label>
      <input type="number" id="wd_input" placeholder="Enter WD" step="1" min="0">
      
      <label for="me_input">Man-day Equivalent (ME):</label>
      <input type="number" id="me_input" placeholder="Enter ME" step="0.1" min="0">
      
      <label for="af_input">Availability Factor (AF):</label>
      <input type="number" id="af_input" placeholder="Enter AF (0-1)" step="0.01" min="0" max="1">
      
      <button id="manday-calc-button">Calculate MD Capability</button>
      <p id="manday-result">Result: </p>
    </div>
  </div>

  <!-- ---------- Calculator Modal ---------- -->
  <!-- Calculator Modal Trigger -->
  <div id="calc-icon" class="calc-icon">ðŸ–©</div>
  <!-- Calculator Modal Structure -->
  <div id="calc-modal" class="calc-modal">
    <div class="calc-content">
      <span id="calc-close" class="calc-close">&times;</span>
      <h2>Calculator</h2>
      <input type="text" id="calc-display" placeholder="0" readonly style="width:100%; padding:10px; margin-bottom:10px; font-size:1em; text-align:right;">
      <div class="calc-buttons">
        <button class="calc-btn" data-value="7">7</button>
        <button class="calc-btn" data-value="8">8</button>
        <button class="calc-btn" data-value="9">9</button>
        <button class="calc-btn" data-value="/">/</button>
        <button class="calc-btn" data-value="4">4</button>
        <button class="calc-btn" data-value="5">5</button>
        <button class="calc-btn" data-value="6">6</button>
        <button class="calc-btn" data-value="*">*</button>
        <button class="calc-btn" data-value="1">1</button>
        <button class="calc-btn" data-value="2">2</button>
        <button class="calc-btn" data-value="3">3</button>
        <button class="calc-btn" data-value="-">-</button>
        <button class="calc-btn" data-value="0">0</button>
        <button class="calc-btn" data-value=".">.</button>
        <button class="calc-btn" data-value="%">%</button>
        <button class="calc-btn" data-value="+">+</button>
        <button class="calc-btn" id="calc-clear" style="grid-column: span 2;">C</button>
        <button class="calc-btn" id="calc-equals" style="grid-column: span 2;">=</button>
      </div>
    </div>
  </div>

  <!-- ---------- JavaScript for Modals ---------- -->
  <script>
    /* ---------- PDF Modal ---------- */
    var pdfModal = document.getElementById("pdf-ref-modal");
    var pdfIcon = document.getElementById("pdf-ref-icon");
    var pdfClose = document.getElementById("pdf-ref-close");

    pdfIcon.addEventListener("click", function() {
      pdfModal.style.display = "block";
    });
    pdfClose.addEventListener("click", function() {
      pdfModal.style.display = "none";
    });
    window.addEventListener("click", function(event) {
      if (event.target == pdfModal) {
        pdfModal.style.display = "none";
      }
    });

    /* ---------- Manday Modal ---------- */
    var mandayModal = document.getElementById("manday-modal");
    var mandayIcon = document.getElementById("manday-icon");
    var mandayClose = document.getElementById("manday-close");
    var mandayCalcButton = document.getElementById("manday-calc-button");
    var mandayResult = document.getElementById("manday-result");

    mandayIcon.addEventListener("click", function() {
      mandayModal.style.display = "block";
    });
    mandayClose.addEventListener("click", function() {
      mandayModal.style.display = "none";
    });
    window.addEventListener("click", function(event) {
      if (event.target == mandayModal) {
        mandayModal.style.display = "none";
      }
    });
    mandayCalcButton.addEventListener("click", function() {
      var dl = parseFloat(document.getElementById("dl_input").value) || 0;
      var wd = parseFloat(document.getElementById("wd_input").value) || 0;
      var me = parseFloat(document.getElementById("me_input").value) || 0;
      var af = parseFloat(document.getElementById("af_input").value) || 0;
      var capability = dl * wd * me * af;
      mandayResult.textContent = "Result: " + capability.toFixed(2) + " MDs";
    });

    /* ---------- Calculator Modal ---------- */
    var calcModal = document.getElementById("calc-modal");
    var calcIcon = document.getElementById("calc-icon");
    var calcClose = document.getElementById("calc-close");
    var calcDisplay = document.getElementById("calc-display");

    calcIcon.addEventListener("click", function() {
      calcModal.style.display = "block";
    });
    calcClose.addEventListener("click", function() {
      calcModal.style.display = "none";
      calcDisplay.value = "";
    });
    window.addEventListener("click", function(event) {
      if (event.target == calcModal) {
        calcModal.style.display = "none";
        calcDisplay.value = "";
      }
    });
    document.querySelectorAll(".calc-btn").forEach(function(button) {
      button.addEventListener("click", function() {
        if (this.id === "calc-clear" || this.id === "calc-equals") return;
        var value = this.getAttribute("data-value");
        calcDisplay.value += value;
      });
    });
    document.getElementById("calc-clear").addEventListener("click", function() {
      calcDisplay.value = "";
    });
    document.getElementById("calc-equals").addEventListener("click", function() {
      try {
        calcDisplay.value = eval(calcDisplay.value);
      } catch (error) {
        calcDisplay.value = "Error";
      }
    });
  </script>
    
</body>
</html>
